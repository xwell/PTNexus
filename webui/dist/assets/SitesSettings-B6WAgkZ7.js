import{m as re,r as m,p as B,O as de,o as ue,f as h,z as c,c as y,h as u,u as pe,b as o,w as s,e as f,x as P,X as me,a4 as ce,v as fe,j as K,l as w,i as d,t as S,aj as _e,ai as ge,Q as ve,g as r}from"./index-BjUns_Ha.js";const ke={class:"cookie-view-container"},ye={class:"top-actions cookie-actions glass-pagination"},we={class:"right-action-group"},be={class:"settings-view"},he={key:0,class:"role-tag role-both"},Ve={key:1,class:"role-tag role-source"},Se={key:2,class:"role-tag role-target"},Ce={style:{display:"flex","justify-content":"center","align-items":"center",width:"100%",height:"100%"}},xe={key:1},Ue={key:1},ze={class:"settings-footer glass-pagination"},Be={class:"pagination-container"},Pe={class:"page-size-text"},Le={key:0,class:"form-tip",style:{color:"#409eff","font-weight":"bold"}},$e={key:1,class:"form-tip",style:{color:"#409eff","font-weight":"bold"}},Me={class:"dialog-footer"},V="/api",Re={__name:"SitesSettings",setup(Ne){const L=m(!1),I=m([]),F=m(new Set),O=m([]),$=m(!1),M=m(!1),p=m({url:"",key:"",e2e_password:""}),U=m(""),C=m("existing_supported"),_=m({currentPage:1,pageSize:30,total:0}),x=m(!1),Y=m(null),n=m({id:null,site:"",nickname:"",base_url:"",special_tracker_domain:"",group:"",cookie:"",passkey:"",speed_limit:0,ratio_threshold:3,seed_speed_limit:5}),q=B(()=>{const l=new Map;for(const e of O.value||[])e&&e.site&&l.set(String(e.site),e);return l}),R=l=>l?.site&&q.value.get(String(l.site))||null,N=l=>{const e=R(l);return e?e.is_source&&e.is_target?"both":e.is_source?"source":e.is_target?"target":"none":"none"},T=l=>{const e=!!l?.has_cookie,a=!!l?.has_passkey,i=["hddolby","m-team","hdtime","rousi"].includes(l?.site);return(!(l?.site!=="rousi")||e)&&(!i||a)},j=B(()=>["existing_supported","supported"].includes(C.value)),A=B(()=>{let l=I.value||[];C.value==="existing_supported"?l=l.filter(a=>{const i=R(a);return!!(i?.is_source||i?.is_target)&&F.value.has(a.site)}):C.value==="supported"&&(l=l.filter(a=>{const i=R(a);return!!(i?.is_source||i?.is_target)}));const e=U.value.trim().toLowerCase();return e&&(l=l.filter(a=>{const i=(a.nickname||"").toLowerCase(),b=(a.site||"").toLowerCase(),v=(a.group||"").toLowerCase();return i.includes(e)||b.includes(e)||v.includes(e)})),j.value?l.slice().sort((a,i)=>{const b=T(a)?0:1,v=T(i)?0:1;return b!==v?v-b:String(a?.nickname||"").localeCompare(String(i?.nickname||""))}):l}),H=B(()=>{_.value.total=A.value.length;const l=(_.value.currentPage-1)*_.value.pageSize,e=l+_.value.pageSize;return A.value.slice(l,e)});de(U,()=>{_.value.currentPage=1}),ue(()=>{Q(),z()});const Q=async()=>{try{const l=await h.get(`${V}/settings`);l.data&&l.data.cookiecloud&&(p.value.url=l.data.cookiecloud.url||"",p.value.key=l.data.cookiecloud.key||"",p.value.e2e_password="")}catch{c.error("加载CookieCloud配置失败！")}},z=async()=>{$.value=!0;try{const[l,e,a]=await Promise.all([h.get(`${V}/sites`,{params:{filter_by_torrents:"all"}}),h.get(`${V}/sites`,{params:{filter_by_torrents:"active"}}),h.get(`${V}/sites/status`)]);I.value=l.data,F.value=new Set((e.data||[]).map(i=>i.site)),O.value=a.data}catch{c.error("获取站点列表失败！")}finally{$.value=!1}},W=()=>{_.value.currentPage=1},X=({row:l})=>j.value?T(l)?"":"row-config-incomplete":"",G=async()=>{if(!p.value.url||!p.value.key){c.warning("CookieCloud URL 和 KEY 不能为空！");return}M.value=!0;try{await h.post(`${V}/settings`,{cookiecloud:p.value});const l=await h.post(`${V}/cookiecloud/sync`,p.value);if(l.data.success){let e=l.data.message;e&&(e=e.replace(/在 CookieCloud 中另有 \d+ 个未匹配的 Cookie。?/,"")),c.success(`配置已保存. ${e||"同步完成！"}`),await z()}else c.error(l.data.message||"同步失败，但配置已保存。")}catch(l){const e=l.response?.data?.message||"操作失败，请检查网络或后端服务。";c.error(e)}finally{M.value=!1}},Z=l=>{const e=JSON.parse(JSON.stringify(l));(e.ratio_threshold===void 0||e.ratio_threshold===null)&&(e.ratio_threshold=3),(e.seed_speed_limit===void 0||e.seed_speed_limit===null)&&(e.seed_speed_limit=5),n.value=e,x.value=!0},ee=async()=>{L.value=!0;try{const l=JSON.parse(JSON.stringify(n.value));l.cookie&&(l.cookie=l.cookie.trim()),(l.ratio_threshold===""||l.ratio_threshold===0)&&(l.ratio_threshold=3),l.seed_speed_limit===""&&(l.seed_speed_limit=5);const e=await h.post(`${V}/sites/update`,l);e.data.success?(c.success(e.data.message),x.value=!1,await z()):c.error(e.data.message||"操作失败！")}catch(l){const e=l.response?.data?.message||"请求失败，请检查网络或后端服务。";c.error(e)}finally{L.value=!1}},te=l=>{ve.confirm("","警告",{confirmButtonText:"确定删除",cancelButtonText:"取消",type:"warning",dangerouslyUseHTMLString:!0,message:`您确定要删除站点【${l.nickname}】吗？<br/>可以通过修改 config.json 然后重启恢复。`}).then(async()=>{try{const e=await h.post(`${V}/sites/delete`,{id:l.id});e.data.success?(c.success("站点已删除。"),await z()):c.error(e.data.message||"删除失败！")}catch(e){const a=e.response?.data?.message||"删除请求失败。";c.error(a)}}).catch(()=>{c.info("操作已取消。")})};return(l,e)=>{const a=f("el-input"),i=f("el-form-item"),b=f("el-icon"),v=f("el-button"),J=f("el-form"),g=f("el-table-column"),k=f("el-tag"),le=f("el-table"),D=f("el-radio-button"),oe=f("el-radio-group"),se=f("el-pagination"),E=f("el-input-number"),ae=f("el-dialog"),ie=fe("loading");return r(),y("div",ke,[u("div",ye,[o(J,{model:p.value,inline:"",class:"cookie-cloud-form"},{default:s(()=>[o(i,{label:"CookieCloud"},{default:s(()=>[o(a,{modelValue:p.value.url,"onUpdate:modelValue":e[0]||(e[0]=t=>p.value.url=t),placeholder:"http://127.0.0.1:8088",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),o(i,{label:"KEY"},{default:s(()=>[o(a,{modelValue:p.value.key,"onUpdate:modelValue":e[1]||(e[1]=t=>p.value.key=t),placeholder:"KEY (UUID)",clearable:"",style:{width:"100px"}},null,8,["modelValue"])]),_:1}),o(i,{label:"端对端密码"},{default:s(()=>[o(a,{modelValue:p.value.e2e_password,"onUpdate:modelValue":e[2]||(e[2]=t=>p.value.e2e_password=t),type:"password","show-password":"",placeholder:"端对端加密密码",clearable:"",style:{width:"125px"}},null,8,["modelValue"])]),_:1}),o(i,null,{default:s(()=>[o(v,{type:"primary",size:"large",onClick:G,loading:M.value},{default:s(()=>[o(b,null,{default:s(()=>[o(P(me))]),_:1}),e[19]||(e[19]=u("span",null,"同步Cookie",-1))]),_:1},8,["loading"])]),_:1})]),_:1},8,["model"]),u("div",we,[o(a,{modelValue:U.value,"onUpdate:modelValue":e[3]||(e[3]=t=>U.value=t),placeholder:"搜索站点昵称/标识/官组",clearable:"","prefix-icon":P(ce),class:"search-input"},null,8,["modelValue","prefix-icon"])])]),pe((r(),y("div",be,[o(le,{data:H.value,class:"settings-table glass-table",height:"100%","row-class-name":X},{default:s(()=>[o(g,{prop:"nickname",label:"站点昵称",width:"100",sortable:""}),o(g,{label:"支持",width:"100",align:"center"},{default:s(t=>[N(t.row)==="both"?(r(),y("span",he," 源站/目标站 ")):N(t.row)==="source"?(r(),y("span",Ve," 源站 ")):N(t.row)==="target"?(r(),y("span",Se," 目标站 ")):K("",!0)]),_:1}),o(g,{prop:"site",label:"站点标识",width:"100","show-overflow-tooltip":""}),o(g,{prop:"base_url",label:"基础URL",width:"150","show-overflow-tooltip":""}),o(g,{prop:"group",label:"官组","show-overflow-tooltip":""}),o(g,{label:"限速",width:"100",align:"center"},{default:s(t=>[u("div",Ce,[t.row.speed_limit==0?(r(),w(k,{key:0,type:"error",size:"small"},{default:s(()=>[...e[20]||(e[20]=[d(" 当前不限速，重启恢复默认限速 ",-1)])]),_:1})):t.row.speed_limit>999?(r(),w(k,{key:1,type:"success",size:"small"},{default:s(()=>[...e[21]||(e[21]=[d(" 不限速 ",-1)])]),_:1})):(r(),w(k,{key:2,type:"primary",size:"small"},{default:s(()=>[d(S(t.row.speed_limit)+" MB/s ",1)]),_:2},1024))])]),_:1}),o(g,{label:"分享率阈值",width:"110",align:"center"},{default:s(t=>[t.row.ratio_threshold?(r(),w(k,{key:0,size:"small",type:"warning"},{default:s(()=>[d(" ≥ "+S(t.row.ratio_threshold),1)]),_:2},1024)):(r(),y("span",xe,"-"))]),_:1}),o(g,{label:"出种限速",width:"110",align:"center"},{default:s(t=>[t.row.ratio_threshold&&t.row.seed_speed_limit!==null?(r(),w(k,{key:0,size:"small",type:"info"},{default:s(()=>[d(S(t.row.seed_speed_limit)+" MB/s ",1)]),_:2},1024)):(r(),y("span",Ue,"-"))]),_:1}),o(g,{label:"Cookie",width:"100",align:"center"},{default:s(t=>[t.row.site==="rousi"?(r(),w(k,{key:0,type:"info"},{default:s(()=>[...e[22]||(e[22]=[d(" 无需配置 ",-1)])]),_:1})):(r(),w(k,{key:1,type:t.row.has_cookie?"success":"danger"},{default:s(()=>[d(S(t.row.has_cookie?"已配置":"未配置"),1)]),_:2},1032,["type"]))]),_:1}),o(g,{label:"Passkey",width:"100",align:"center"},{default:s(t=>[["hddolby","m-team","hdtime","rousi"].includes(t.row.site)?(r(),w(k,{key:0,type:t.row.has_passkey?"success":"danger"},{default:s(()=>[d(S(t.row.has_passkey?"已配置":"未配置"),1)]),_:2},1032,["type"])):(r(),w(k,{key:1,type:"success"},{default:s(()=>[...e[23]||(e[23]=[d(" 自动获取 ",-1)])]),_:1}))]),_:1}),o(g,{label:"操作",width:"180",align:"center",fixed:"right"},{default:s(t=>[o(v,{type:"primary",icon:P(_e),link:"",onClick:ne=>Z(t.row)},{default:s(()=>[...e[24]||(e[24]=[d(" 编辑 ",-1)])]),_:1},8,["icon","onClick"]),o(v,{type:"danger",icon:P(ge),link:"",onClick:ne=>te(t.row)},{default:s(()=>[...e[25]||(e[25]=[d(" 删除 ",-1)])]),_:1},8,["icon","onClick"])]),_:1})]),_:1},8,["data"])])),[[ie,$.value]]),u("div",ze,[o(oe,{modelValue:C.value,"onUpdate:modelValue":e[4]||(e[4]=t=>C.value=t),onChange:W},{default:s(()=>[o(D,{label:"existing_supported"},{default:s(()=>[...e[26]||(e[26]=[d("已有支持站点",-1)])]),_:1}),o(D,{label:"supported"},{default:s(()=>[...e[27]||(e[27]=[d("所有支持站点",-1)])]),_:1}),o(D,{label:"all"},{default:s(()=>[...e[28]||(e[28]=[d("所有站点",-1)])]),_:1})]),_:1},8,["modelValue"]),u("div",Be,[u("div",Pe,S(_.value.pageSize)+" 条/页",1),o(se,{"current-page":_.value.currentPage,"onUpdate:currentPage":e[5]||(e[5]=t=>_.value.currentPage=t),"page-size":_.value.pageSize,"onUpdate:pageSize":e[6]||(e[6]=t=>_.value.pageSize=t),total:_.value.total,layout:"total, prev, pager, next, jumper",background:""},null,8,["current-page","page-size","total"])])]),o(ae,{modelValue:x.value,"onUpdate:modelValue":e[18]||(e[18]=t=>x.value=t),title:"编辑站点",width:"700px","close-on-click-modal":!1,class:"site-edit-dialog"},{footer:s(()=>[u("span",Me,[o(v,{onClick:e[17]||(e[17]=t=>x.value=!1)},{default:s(()=>[...e[36]||(e[36]=[d("取消",-1)])]),_:1}),o(v,{type:"primary",onClick:ee,loading:L.value},{default:s(()=>[...e[37]||(e[37]=[d(" 保存 ",-1)])]),_:1},8,["loading"])])]),default:s(()=>[o(J,{model:n.value,ref_key:"siteFormRef",ref:Y,"label-width":"140px","label-position":"left"},{default:s(()=>[o(i,{label:"站点标识",prop:"site",required:""},{default:s(()=>[o(a,{modelValue:n.value.site,"onUpdate:modelValue":e[7]||(e[7]=t=>n.value.site=t),placeholder:"例如：pt",disabled:""},null,8,["modelValue"]),e[29]||(e[29]=u("div",{class:"form-tip"},"站点标识不可修改。",-1))]),_:1}),o(i,{label:"站点昵称",prop:"nickname",required:""},{default:s(()=>[o(a,{modelValue:n.value.nickname,"onUpdate:modelValue":e[8]||(e[8]=t=>n.value.nickname=t),placeholder:"例如：PT站"},null,8,["modelValue"])]),_:1}),o(i,{label:"基础URL",prop:"base_url"},{default:s(()=>[o(a,{modelValue:n.value.base_url,"onUpdate:modelValue":e[9]||(e[9]=t=>n.value.base_url=t),placeholder:"例如：pt.com"},null,8,["modelValue"]),e[30]||(e[30]=u("div",{class:"form-tip"},"用于拼接种子详情页链接。",-1))]),_:1}),o(i,{label:"Tracker域名",prop:"special_tracker_domain"},{default:s(()=>[o(a,{modelValue:n.value.special_tracker_domain,"onUpdate:modelValue":e[10]||(e[10]=t=>n.value.special_tracker_domain=t),placeholder:"例如：pt-tracker.com"},null,8,["modelValue"]),e[31]||(e[31]=u("div",{class:"form-tip"}," 如果站点的Tracker域名与主域名的二级域名（则域名去掉前缀后缀部分）不同，请在此填写。 ",-1))]),_:1}),o(i,{label:"关联官组",prop:"group"},{default:s(()=>[o(a,{modelValue:n.value.group,"onUpdate:modelValue":e[11]||(e[11]=t=>n.value.group=t),placeholder:"例如：PT, PTWEB"},null,8,["modelValue"]),e[32]||(e[32]=u("div",{class:"form-tip"},"用于识别种子所属发布组，多个组用英文逗号(,)分隔。",-1))]),_:1}),o(i,{label:"Cookie",prop:"cookie"},{default:s(()=>[o(a,{modelValue:n.value.cookie,"onUpdate:modelValue":e[12]||(e[12]=t=>n.value.cookie=t),type:"textarea",rows:3,placeholder:n.value.site==="rousi"?"无需设置":"从浏览器获取的Cookie字符串",disabled:n.value.site==="rousi"},null,8,["modelValue","placeholder","disabled"])]),_:1}),o(i,{label:"Passkey",prop:"passkey"},{default:s(()=>[o(a,{modelValue:n.value.passkey,"onUpdate:modelValue":e[13]||(e[13]=t=>n.value.passkey=t),placeholder:"站点的Passkey"},null,8,["modelValue"]),n.value.site==="hddolby"?(r(),y("div",Le," 杜比的passkey为种子详情页复制种子链接时downhash=后的部分 ")):n.value.site==="rousi"?(r(),y("div",$e," 肉丝的passkey在个人用户-设置-passkey ")):K("",!0)]),_:1}),o(i,{label:"上传限速 (MB/s)",prop:"speed_limit"},{default:s(()=>[o(E,{modelValue:n.value.speed_limit,"onUpdate:modelValue":e[14]||(e[14]=t=>n.value.speed_limit=t),min:0,max:1e3,style:{width:"100%"}},null,8,["modelValue"]),e[33]||(e[33]=u("div",{class:"form-tip",style:{color:"red","font-size":"12px"}}," 填写 0 重启恢复默认；超过 999 显示不限速 ",-1))]),_:1}),o(i,{label:"分享率阈值",prop:"ratio_threshold"},{default:s(()=>[o(E,{modelValue:n.value.ratio_threshold,"onUpdate:modelValue":e[15]||(e[15]=t=>n.value.ratio_threshold=t),min:1.2,max:100,step:.1,precision:1,style:{width:"100%"}},null,8,["modelValue"]),e[34]||(e[34]=u("div",{class:"form-tip",style:{"font-size":"12px"}},"默认 3.0，达到后触发出种限速",-1))]),_:1}),o(i,{label:"出种限速 (MB/s)",prop:"seed_speed_limit"},{default:s(()=>[o(E,{modelValue:n.value.seed_speed_limit,"onUpdate:modelValue":e[16]||(e[16]=t=>n.value.seed_speed_limit=t),min:0,max:1e3,style:{width:"100%"}},null,8,["modelValue"]),e[35]||(e[35]=u("div",{class:"form-tip",style:{color:"#409eff","font-size":"12px"}},"默认 5 MB/s",-1))]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},De=re(Re,[["__scopeId","data-v-2ad22b70"]]);export{De as default};
