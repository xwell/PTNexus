import{d as re,r as _,p as A,o as ie,c as u,h as t,u as $,v as de,l as p,w as o,b as a,e as c,j as v,x as ue,a4 as ce,f as x,t as d,F as B,k as q,i as g,g as r,z as W,m as _e}from"./index-BiuajaRa.js";const pe={class:"sites-view-container"},ve={class:"layout-wrapper"},me={class:"quadrant glass-card glass-rounded"},ge={class:"table-wrapper"},fe={class:"quadrant glass-card glass-rounded"},he={class:"quadrant-title",style:{display:"flex","align-items":"center",gap:"10px"}},ye={class:"table-wrapper"},be={class:"quadrant local-scan-quadrant glass-card glass-rounded"},we={class:"scan-header"},xe={class:"scan-controls"},ke={style:{float:"right",color:"#8492a6","font-size":"13px"}},ze={key:0,class:"scan-summary glass-card glass-rounded"},Ve={class:"stat-item"},Se={class:"stat-value"},Be={class:"stat-item"},qe={class:"stat-value"},Ce={class:"stat-item stat-danger"},Me={class:"stat-value"},Ae={class:"stat-item stat-warning"},De={class:"stat-value"},Fe={class:"stat-item stat-success"},Ee={class:"stat-value"},Pe={key:1,class:"scan-results glass-card glass-rounded"},Ue={style:{display:"flex","align-items":"center",gap:"12px"}},Ne={class:"tab-label"},Re={class:"tab-label"},Te={class:"tab-label"},$e={class:"tab-content-area"},Le={key:0,class:"tab-content"},je={key:1,class:"tab-content"},Ge={key:2,class:"tab-content"},We={key:1},Ke={key:2,"element-loading-text":"正在扫描本地文件...","element-loading-background":"transparent",class:"loading-container"},Oe={key:3,style:{display:"flex","align-items":"center","justify-content":"center",flex:"1"}},He=re({__name:"SitesView",emits:["ready"],setup(Je,{emit:K}){const O=K,D=_(!0),F=_(!0),C=_([]),E=_([]),k=_(""),b=_(!1),z=_("missing"),n=_(null),V=_(""),L=_([]),f=_(""),H=A(()=>{if(!n.value)return[];const l=new Set;return n.value.missing_files&&n.value.missing_files.forEach(e=>l.add(e.save_path)),n.value.orphaned_files&&n.value.orphaned_files.forEach(e=>l.add(e.path)),n.value.synced_torrents&&n.value.synced_torrents.forEach(e=>l.add(e.path)),Array.from(l).sort()}),J=A(()=>n.value?.missing_files?f.value?n.value.missing_files.filter(l=>l.save_path===f.value):n.value.missing_files:[]),Q=A(()=>n.value?.orphaned_files?f.value?n.value.orphaned_files.filter(l=>l.path===f.value):n.value.orphaned_files:[]),X=A(()=>n.value?.synced_torrents?f.value?n.value.synced_torrents.filter(l=>l.path===f.value):n.value.synced_torrents:[]),M=(l,e=2)=>{if(!+l)return"0 Bytes";const m=1024,i=e<0?0:e,h=["Bytes","KB","MB","GB","TB","PB"],w=Math.floor(Math.log(l)/Math.log(m));return`${parseFloat((l/Math.pow(m,w)).toFixed(i))} ${h[w]}`},Y=async()=>{D.value=!0;try{const e=(await x.get("/api/site_stats")).data;C.value=Array.isArray(e)?e:[]}catch(l){console.error("获取站点统计数据失败:",l),C.value=[]}finally{D.value=!1}},j=async()=>{F.value=!0;try{const l=k.value?`/api/group_stats?site=${encodeURIComponent(k.value)}`:"/api/group_stats",m=(await x.get(l)).data;E.value=Array.isArray(m)?m:[]}catch(l){console.error("获取官组统计数据失败:",l),E.value=[]}finally{F.value=!1}},Z=()=>{j()},I=async()=>{try{const l=await x.get("/api/local_query/downloaders_with_paths");L.value=l.data.downloaders||[]}catch(l){console.error("获取路径列表失败:",l)}},ee=async()=>{try{const l=await x.get("/api/local_query/scan/cache");n.value=l.data,console.log("已加载缓存的扫描结果")}catch(l){x.isAxiosError(l)&&l.response?.status!==404&&console.error("获取缓存扫描结果失败:",l)}},ae=async()=>{b.value=!0,n.value=null;try{const l=V.value?`/api/local_query/scan?path=${encodeURIComponent(V.value)}`:"/api/local_query/scan",e=await x.post(l);n.value=e.data,W.success("扫描完成！")}catch(l){console.error("扫描失败:",l),W.error("扫描失败，请查看控制台获取详情")}finally{b.value=!1}},G=async()=>{await Promise.all([Y(),j(),I(),ee()])};return ie(()=>{G(),O("ready",G)}),(l,e)=>{const m=c("el-empty"),i=c("el-table-column"),h=c("el-table"),w=c("el-option"),P=c("el-select"),te=c("el-option-group"),se=c("el-button"),S=c("el-col"),le=c("el-row"),U=c("el-badge"),N=c("el-tab-pane"),ne=c("el-tabs"),R=c("el-tag"),T=de("loading");return r(),u("div",pe,[t("div",ve,[t("div",me,[e[4]||(e[4]=t("h2",{class:"quadrant-title"},"做种站点统计",-1)),t("div",ge,[$((r(),p(h,{data:C.value,class:"stats-table glass-table",border:"",height:"100%","default-sort":{prop:"total_size",order:"descending"}},{empty:o(()=>[a(m,{description:"无站点数据"})]),default:o(()=>[a(i,{prop:"site_name",label:"站点名称",align:"center",sortable:"","min-width":"120"}),a(i,{prop:"torrent_count",label:"做种数量",sortable:"",align:"center"}),a(i,{prop:"total_size",label:"做种总体积",sortable:"",align:"center","min-width":"100"},{default:o(s=>[t("span",null,d(M(s.row.total_size)),1)]),_:1})]),_:1},8,["data"])),[[T,D.value]])])]),t("div",fe,[t("h2",he,[e[5]||(e[5]=t("span",null,"做种官组统计",-1)),a(P,{modelValue:k.value,"onUpdate:modelValue":e[0]||(e[0]=s=>k.value=s),placeholder:"全部站点",clearable:"",filterable:"",size:"small",style:{width:"240px"},onChange:Z},{default:o(()=>[(r(!0),u(B,null,q(C.value,s=>(r(),p(w,{key:s.site_name,label:s.site_name,value:s.site_name},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),t("div",ye,[$((r(),p(h,{data:E.value,class:"stats-table glass-table",border:"",height:"100%","default-sort":{prop:"total_size",order:"descending"}},{empty:o(()=>[a(m,{description:"无官组数据"})]),default:o(()=>[a(i,{prop:"site_name",label:"所属站点",align:"center",sortable:"",width:"110"}),a(i,{label:(k.value,"官组"),prop:"group_suffix",sortable:"",align:"center"},null,8,["label"]),a(i,{prop:"torrent_count",label:"数量",sortable:"",align:"center",width:"80"}),a(i,{prop:"total_size",label:"体积",sortable:"",align:"center",width:"90"},{default:o(s=>[t("span",null,d(M(s.row.total_size)),1)]),_:1})]),_:1},8,["data"])),[[T,F.value]])])]),t("div",be,[t("div",we,[e[6]||(e[6]=t("div",{class:"scan-header-left"},[t("h2",{class:"quadrant-title"},"本地文件扫描"),t("p",{class:"scan-description"},"扫描数据库中所有种子的保存路径，找出本地已删除的文件或未被任务引用的孤立文件。为防止误删除种子，所以不提供一键删除功能。")],-1)),t("div",xe,[a(P,{modelValue:V.value,"onUpdate:modelValue":e[1]||(e[1]=s=>V.value=s),clearable:"",placeholder:"选择路径(可选)",filterable:"",size:"default",style:{width:"280px","margin-right":"10px"}},{default:o(()=>[(r(!0),u(B,null,q(L.value,s=>(r(),p(te,{key:s.id,label:s.name},{default:o(()=>[(r(!0),u(B,null,q(s.paths,y=>(r(),p(w,{key:y.path,label:y.path,value:y.path},{default:o(()=>[t("span",null,d(y.path),1),t("span",ke,"("+d(y.count)+")",1)]),_:2},1032,["label","value"]))),128))]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"]),a(se,{type:"primary",onClick:ae,loading:b.value,icon:ue(ce)},{default:o(()=>[g(d(V.value?"扫描选定路径":"扫描全部路径"),1)]),_:1},8,["loading","icon"])])]),n.value?(r(),u("div",ze,[a(le,{gutter:16},{default:o(()=>[a(S,{span:4},{default:o(()=>[t("div",Ve,[t("div",Se,d(n.value.scan_summary.total_torrents),1),e[7]||(e[7]=t("div",{class:"stat-label"},"总种子数",-1))])]),_:1}),a(S,{span:5},{default:o(()=>[t("div",Be,[t("div",qe,d(n.value.scan_summary.total_local_items),1),e[8]||(e[8]=t("div",{class:"stat-label"},"本地文件数",-1))])]),_:1}),a(S,{span:5},{default:o(()=>[t("div",Ce,[t("div",Me,d(n.value.scan_summary.missing_count),1),e[9]||(e[9]=t("div",{class:"stat-label"},"缺失文件",-1))])]),_:1}),a(S,{span:5},{default:o(()=>[t("div",Ae,[t("div",De,d(n.value.scan_summary.orphaned_count),1),e[10]||(e[10]=t("div",{class:"stat-label"},"孤立文件",-1))])]),_:1}),a(S,{span:5},{default:o(()=>[t("div",Fe,[t("div",Ee,d(n.value.scan_summary.synced_count),1),e[11]||(e[11]=t("div",{class:"stat-label"},"正常做种",-1))])]),_:1})]),_:1})])):v("",!0),n.value?(r(),u("div",Pe,[t("div",Ue,[a(ne,{modelValue:z.value,"onUpdate:modelValue":e[2]||(e[2]=s=>z.value=s),style:{flex:"0 0 auto"}},{default:o(()=>[a(N,{name:"missing"},{label:o(()=>[t("span",Ne,[e[12]||(e[12]=g(" 缺失文件 ",-1)),n.value.scan_summary.missing_count>0?(r(),p(U,{key:0,value:n.value.scan_summary.missing_count,type:"danger",max:999999},null,8,["value"])):v("",!0)])]),_:1}),a(N,{name:"orphaned"},{label:o(()=>[t("span",Re,[e[13]||(e[13]=g(" 孤立文件 ",-1)),n.value.scan_summary.orphaned_count>0?(r(),p(U,{key:0,value:n.value.scan_summary.orphaned_count,type:"warning",max:999999},null,8,["value"])):v("",!0)])]),_:1}),a(N,{name:"synced"},{label:o(()=>[t("span",Te,[e[14]||(e[14]=g(" 正常做种 ",-1)),n.value.scan_summary.synced_count>0?(r(),p(U,{key:0,value:n.value.scan_summary.synced_count,type:"success",max:999999},null,8,["value"])):v("",!0)])]),_:1})]),_:1},8,["modelValue"]),a(P,{modelValue:f.value,"onUpdate:modelValue":e[3]||(e[3]=s=>f.value=s),placeholder:"筛选路径",clearable:"",filterable:"",style:{width:"240px"}},{default:o(()=>[(r(!0),u(B,null,q(H.value,s=>(r(),p(w,{key:s,label:s,value:s},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),t("div",$e,[z.value==="missing"?(r(),u("div",Le,[a(h,{data:J.value,class:"glass-table glass-transition",height:"100%","default-sort":{prop:"size",order:"descending"}},{default:o(()=>[a(i,{prop:"name",label:"种子名称","show-overflow-tooltip":"",align:"left","header-align":"center"}),a(i,{prop:"save_path",label:"保存路径",align:"center",width:"250","show-overflow-tooltip":"","header-align":"center"}),a(i,{prop:"size",label:"大小",width:"110",sortable:"",align:"center"},{default:o(({row:s})=>[g(d(M(s.size)),1)]),_:1}),a(i,{prop:"downloader_name",label:"下载器",width:"120",align:"center"})]),_:1},8,["data"])])):v("",!0),z.value==="orphaned"?(r(),u("div",je,[a(h,{data:Q.value,class:"glass-table glass-transition",height:"100%","default-sort":{prop:"size",order:"descending"}},{default:o(()=>[a(i,{prop:"name",label:"文件/文件夹名称","show-overflow-tooltip":"",align:"left","header-align":"center"}),a(i,{prop:"path",label:"所在路径",width:"250",align:"center","show-overflow-tooltip":{placement:"left"},"header-align":"center"}),a(i,{prop:"size",label:"大小",width:"120",sortable:"",align:"center"},{default:o(({row:s})=>[g(d(s.size?M(s.size):"未知"),1)]),_:1}),a(i,{prop:"is_file",label:"类型",width:"120",align:"center","header-align":"center"},{default:o(({row:s})=>[a(R,{type:s.is_file?"success":"info",size:"small"},{default:o(()=>[g(d(s.is_file?"文件":"文件夹"),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])])):v("",!0),z.value==="synced"?(r(),u("div",Ge,[a(h,{data:X.value,class:"glass-table glass-transition",height:"100%"},{default:o(()=>[a(i,{prop:"name",label:"名称","show-overflow-tooltip":"",align:"left","header-align":"center"}),a(i,{prop:"path",label:"路径",width:"250","show-overflow-tooltip":"",align:"center","header-align":"center"}),a(i,{prop:"torrents_count",label:"任务数",width:"120",align:"center","header-align":"center"},{default:o(({row:s})=>[s.torrents_count>0?(r(),p(R,{key:0,type:"warning",size:"small"},{default:o(()=>[g(d(s.torrents_count),1)]),_:2},1024)):(r(),u("span",We,d(s.torrents_count),1))]),_:1}),a(i,{label:"下载器",width:"120",align:"center","header-align":"center"},{default:o(({row:s})=>[(r(!0),u(B,null,q(s.downloader_names,(y,oe)=>(r(),p(R,{key:oe,size:"small",style:{"margin-right":"4px"}},{default:o(()=>[g(d(y),1)]),_:2},1024))),128))]),_:1})]),_:1},8,["data"])])):v("",!0)])])):v("",!0),b.value?$((r(),u("div",Ke,null,512)),[[T,b.value]]):v("",!0),!n.value&&!b.value?(r(),u("div",Oe,[a(m,{description:"点击扫描按钮进行本地文件检查"})])):v("",!0)])])])}}}),Xe=_e(He,[["__scopeId","data-v-3269c295"]]);export{Xe as default};
