import{m as ce,r as _,p as te,o as ue,q as pe,s as ve,u as fe,v as he,c as X,h as s,b as ge,w as me,n as r,x as be,y as ye,t as T,F as we,k as _e,f as j,z as Ce,A as ae,g as H,B as xe}from"./index-BjUns_Ha.js";const ke={class:"info-view-container"},$e={class:"chart-card glass-card glass-rounded"},Ne={class:"chart-header"},Ae={class:"header-left-controls"},De={class:"button-group"},Se={class:"button-wrapper"},Be=["disabled"],Fe={class:"chart-title"},Me={class:"header-right-controls"},Ee={class:"button-group"},Ie={class:"custom-legend-container"},Te=["onClick"],Le={class:"legend-item-content"},Oe=["title"],Ve={class:"legend-speed-info"},ze={class:"chart-card glass-card glass-rounded"},Ue={class:"chart-header"},We={class:"header-left-controls"},Ge={class:"button-group"},Ze={class:"chart-title"},qe={class:"header-right-controls"},Ke={class:"button-group"},Pe={__name:"InfoView",setup(Re){const Z=_(null),q=_(null);let c=null,m=null,S=null,K=!1,L=null;const p=_("last_1_min"),h=_("today"),A=_("all"),E=_("all"),O=_([]),D=_([]),B=_(!0),P=_(!0),J={last_1_min:"近1分钟",today:"今日",yesterday:"昨日",this_week:"本周",last_week:"上周",this_month:"本月",last_month:"上月",this_year:"今年",all:"全部"},se=te(()=>`(${J[p.value]})`),le=te(()=>`(${J[h.value]})`),N=t=>{if(t==null||isNaN(t)||t<0||t===0)return"0 B";const e=["B","KB","MB","GB","TB","PB"],o=Math.floor(Math.log(t)/Math.log(1024));return`${parseFloat((t/Math.pow(1024,o)).toFixed(2))} ${e[o]}`},F=t=>N(t)+"/s",oe=async()=>{try{const{data:t}=await j.get("/api/settings");B.value=t.realtime_speed_enabled}catch(t){console.error("获取应用设置失败:",t),Ce.error("获取应用设置失败，部分功能可能不正常。"),B.value=!0}},ne=()=>{Z.value&&(c=ae(Z.value),c.setOption({tooltip:{trigger:"axis",position:function(t,e,o,a,l){l.viewSize[0];const n=l.contentSize[0];let d=t[0]-n-10;return d<0&&(d=t[0]+20),[d,t[1]-20]},formatter:t=>{if(!t||t.length===0)return"";const e=new Map(O.value.map(l=>[l.id,l.name]));let o=`${t[0].axisValueLabel}<br/>`;const a={};t.forEach(l=>{const d=c.getOption().series[l.seriesIndex].name,b=d.includes("↑"),k=b?d.indexOf("↑"):d.indexOf("↓"),M=d.substring(0,d.lastIndexOf(" ",k)).trim(),f=O.value.find(v=>v.name===M);f&&(a[f.id]||(a[f.id]={}),b?a[f.id].上传={value:l.value,color:l.color}:a[f.id].下载={value:l.value,color:l.color})});for(const l in a){const n=a[l],d=e.get(l)||"未知下载器";o+=`<div style="margin-top: 8px; font-weight: bold;">${d}</div>`,n.上传&&(o+=`<div><span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${n.上传.color};"></span>上传: ${F(n.上传.value)}</div>`),n.下载&&(o+=`<div><span style="display:inline-block;margin-right:5px;border-radius:10px;width:10px;height:10px;background-color:${n.下载.color};"></span>下载: ${F(n.下载.value)}</div>`)}return o}},xAxis:{type:"category",data:[],boundaryGap:!1},yAxis:{type:"value",axisLabel:{formatter:t=>F(t)}},series:[],grid:{top:85,left:"3%",right:"4%",bottom:"3%",containLabel:!0},legend:{show:!1},dataZoom:[{type:"inside"}]}),c.on("legendselectchanged",t=>{const e=t.selected;D.value=D.value.map(o=>({...o,disabled:!e[o.fullName]}))}),c.on("mouseover",()=>K=!0),c.on("mouseout",()=>{K=!1,L=null}),c.on("mousemove",t=>{t.dataIndex!==void 0&&(L=t.dataIndex)}))},ie=()=>{q.value&&(m=ae(q.value),m.setOption({tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:t=>{if(!t||t.length===0)return"";let e=`${t[0].axisValueLabel}<br/>`;const o={};t.forEach(a=>{const l=a.seriesName.split(" - ")[0];o[l]||(o[l]={}),a.seriesName.includes("上传量")?o[l].上传={value:a.value,marker:a.marker}:a.seriesName.includes("下载量")&&(o[l].下载={value:a.value,marker:a.marker})});for(const a in o){const l=o[a];e+=`<div style="margin-top: 8px; font-weight: bold;">${a}</div>`,l.上传&&(e+=`${l.上传.marker} 上传: ${N(l.上传.value)}<br/>`),l.下载&&(e+=`${l.下载.marker} 下载: ${N(l.下载.value)}<br/>`)}return e}},xAxis:{type:"category",data:[]},yAxis:{type:"value",axisLabel:{formatter:t=>N(t)}},series:[],grid:{top:80,left:"3%",right:"4%",bottom:"3%",containLabel:!0},legend:{type:"scroll",top:"top"},dataZoom:[{type:"inside"}]}))},Q=async(t,e=!1)=>{if(c){e||c.showLoading();try{const o=t==="last_1_min"?"/api/recent_speed_data":"/api/speed_chart_data",a=t==="last_1_min"?{seconds:60}:{range:t},{data:l}=await j.get(o,{params:a});O.value=l.downloaders||[];const n=[],d=[],b=["#F56C6C","#E6A23C","#D98A6F","#FAB6B6","#F7D0A3"],k=["#409EFF","#67C23A","#8A2BE2","#A0CFFF","#B3E19D"],M=l.datasets.length>0?l.datasets[l.datasets.length-1]:null,f=[],v=[];O.value.forEach((i,g)=>{const W=M?.speeds?.[i.id]||{ul_speed:0,dl_speed:0},G=F(W.ul_speed||0),I=`${i.name} ↑ ${G}`;d.push({fullName:I,baseName:i.name,arrow:"↑",speed:G,color:b[g%b.length],disabled:!1});const y=l.datasets.map(R=>R.speeds[i.id]?.ul_speed||0);f.push(...y),n.push({name:I,type:"line",smooth:!0,showSymbol:!1,data:y,color:b[g%b.length]});const w=F(W.dl_speed||0),Y=`${i.name} ↓ ${w}`;d.push({fullName:Y,baseName:i.name,arrow:"↓",speed:w,color:k[g%k.length],disabled:!1});const ee=l.datasets.map(R=>R.speeds[i.id]?.dl_speed||0);v.push(...ee),n.push({name:Y,type:"line",smooth:!0,showSymbol:!1,data:ee,color:k[g%k.length]})});let u=null;A.value==="upload"?u=Math.max(...f):A.value==="download"?u=Math.max(...v):u=Math.max(...f,...v),u===0&&(u=1024),u=u*1.2;const $=D.value.reduce((i,g)=>(g.disabled&&(i[`${g.baseName} ${g.arrow}`]=!0),i),{});d.forEach(i=>{$[`${i.baseName} ${i.arrow}`]&&(i.disabled=!0)}),D.value=d;const U=c.getOption().legend?.[0]?.selected||{};d.forEach(i=>{U[i.fullName]=!i.disabled}),c.setOption({xAxis:{data:l.labels},yAxis:{type:"value",axisLabel:{formatter:i=>F(i)},max:u},series:n,legend:{show:!1,data:d.map(i=>i.fullName),selected:U}}),V(A.value,!0),e&&K&&L!==null&&c.dispatchAction({type:"showTip",seriesIndex:0,dataIndex:L})}catch(o){console.error("获取速率数据失败:",o)}finally{e||c.hideLoading()}}},re=async t=>{if(m){m.showLoading();try{const{data:e}=await j.get("/api/chart_data",{params:{range:t}}),{labels:o,datasets:a,downloaders:l}=e,n=[],d=[],b=["#F56C6C","#E6A23C","#D98A6F","#FAB6B6","#F7D0A3"],k=["#409EFF","#67C23A","#8A2BE2","#A0CFFF","#B3E19D"],M=new Array(o.length).fill(0),f=new Array(o.length).fill(0);l.forEach((v,u)=>{const $=a[v.id];if(!$)return;const U=$.uploaded.reduce((y,w)=>y+w,0),i=N(U),g=`${v.name} - 上传量 (${i})`,W=$.downloaded.reduce((y,w)=>y+w,0),G=N(W),I=`${v.name} - 下载量 (${G})`;$.uploaded.forEach((y,w)=>{M[w]+=y}),$.downloaded.forEach((y,w)=>{f[w]+=y}),d.push(g),n.push({name:g,type:"bar",stack:"upload",emphasis:{focus:"series"},data:$.uploaded,color:b[u%b.length]}),d.push(I),n.push({name:I,type:"bar",stack:"download",emphasis:{focus:"series"},data:$.downloaded,color:k[u%k.length]})}),n.push({name:"上传总量标签",type:"bar",stack:"upload",data:new Array(o.length).fill(0),itemStyle:{borderColor:"transparent",color:"transparent"},emphasis:{itemStyle:{borderColor:"transparent",color:"transparent"}},tooltip:{show:!1},label:{show:!0,position:"top",formatter:v=>{const u=M[v.dataIndex];return u>0?N(u):""},color:"#333",fontSize:10,fontWeight:"normal"}}),n.push({name:"下载总量标签",type:"bar",stack:"download",data:new Array(o.length).fill(0),itemStyle:{borderColor:"transparent",color:"transparent"},emphasis:{itemStyle:{borderColor:"transparent",color:"transparent"}},tooltip:{show:!1},label:{show:!0,position:"top",formatter:v=>{const u=f[v.dataIndex];return u>0?N(u):""},color:"#333",fontSize:10,fontWeight:"normal"}}),m.setOption({xAxis:{data:o},series:n,legend:{data:d,top:"top"}}),z(E.value,!0)}catch(e){console.error("获取数据量数据失败:",e)}finally{m.hideLoading()}}},C=t=>{S&&(clearInterval(S),S=null),p.value=t,Q(t),t==="last_1_min"&&B.value&&(S=setInterval(()=>{Q(t,!0)},1e3))},x=t=>{h.value=t,re(t)},de=t=>{c&&c.dispatchAction({type:"legendToggleSelect",name:t})},V=(t,e=!1)=>{if(e||(A.value=t),!c||!D.value.length)return;const o={};D.value.forEach(a=>{t==="all"?o[a.fullName]=!0:t==="upload"?o[a.fullName]=a.arrow==="↑":t==="download"&&(o[a.fullName]=a.arrow==="↓")}),c.setOption({legend:{selected:o}})},z=(t,e=!1)=>{if(e||(E.value=t),!m)return;const o=m.getOption();if(!o||!o.legend||!o.legend[0]||!o.legend[0].data)return;const a=o.legend[0].data,l={};a.forEach(n=>{t==="all"?l[n]=!0:t==="upload"?l[n]=n.includes("上传量"):t==="download"&&(l[n]=n.includes("下载量"))}),m.setOption({legend:{selected:l}})};return ue(async()=>{P.value=!0,await oe(),!B.value&&p.value==="last_1_min"&&(p.value="today"),await pe(),ne(),ie(),C(p.value),x(h.value),window.addEventListener("resize",()=>{c?.resize(),m?.resize()}),P.value=!1}),ve(()=>{S&&clearInterval(S)}),(t,e)=>{const o=he("loading");return fe((H(),X("div",ke,[s("div",$e,[s("div",Ne,[s("div",Ae,[s("div",De,[ge(be(ye),{content:"请在设置页面开启“实时速率”以使用此功能",disabled:B.value,placement:"top"},{default:me(()=>[s("div",Se,[s("button",{onClick:e[0]||(e[0]=a=>C("last_1_min")),class:r({active:p.value==="last_1_min"}),disabled:!B.value}," 近1分钟 ",10,Be)])]),_:1},8,["disabled"]),s("button",{onClick:e[1]||(e[1]=a=>C("today")),class:r({active:p.value==="today"})}," 今日 ",2),s("button",{onClick:e[2]||(e[2]=a=>C("yesterday")),class:r({active:p.value==="yesterday"})}," 昨日 ",2),s("button",{onClick:e[3]||(e[3]=a=>C("this_week")),class:r({active:p.value==="this_week"})}," 本周 ",2),s("button",{onClick:e[4]||(e[4]=a=>C("last_week")),class:r({active:p.value==="last_week"})}," 上周 ",2),s("button",{onClick:e[5]||(e[5]=a=>C("this_month")),class:r({active:p.value==="this_month"})}," 本月 ",2),s("button",{onClick:e[6]||(e[6]=a=>C("last_month")),class:r({active:p.value==="last_month"})}," 上月 ",2),s("button",{onClick:e[7]||(e[7]=a=>C("all")),class:r({active:p.value==="all"})}," 全部 ",2)])]),s("div",Fe,"速率 "+T(se.value),1),s("div",Me,[s("div",Ee,[s("button",{onClick:e[8]||(e[8]=a=>V("all")),class:r({active:A.value==="all"})}," 全部 ",2),s("button",{onClick:e[9]||(e[9]=a=>V("upload")),class:r({active:A.value==="upload"})}," 仅上传 ",2),s("button",{onClick:e[10]||(e[10]=a=>V("download")),class:r({active:A.value==="download"})}," 仅下载 ",2)])])]),s("div",Ie,[(H(!0),X(we,null,_e(D.value,a=>(H(),X("span",{key:a.fullName,class:r(["legend-item",{disabled:a.disabled}]),onClick:l=>de(a.fullName)},[s("span",{class:"legend-color-box",style:xe({backgroundColor:a.color})},null,4),s("span",Le,[s("span",{class:"legend-base-name",title:a.baseName},T(a.baseName)+T(a.arrow),9,Oe),s("span",Ve,T(a.speed),1)])],10,Te))),128))]),s("div",{ref_key:"speedChart",ref:Z,class:"chart-body"},null,512)]),s("div",ze,[s("div",Ue,[s("div",We,[s("div",Ge,[s("button",{onClick:e[11]||(e[11]=a=>x("today")),class:r({active:h.value==="today"})}," 今日 ",2),s("button",{onClick:e[12]||(e[12]=a=>x("yesterday")),class:r({active:h.value==="yesterday"})}," 昨日 ",2),s("button",{onClick:e[13]||(e[13]=a=>x("this_week")),class:r({active:h.value==="this_week"})}," 本周 ",2),s("button",{onClick:e[14]||(e[14]=a=>x("last_week")),class:r({active:h.value==="last_week"})}," 上周 ",2),s("button",{onClick:e[15]||(e[15]=a=>x("this_month")),class:r({active:h.value==="this_month"})}," 本月 ",2),s("button",{onClick:e[16]||(e[16]=a=>x("last_month")),class:r({active:h.value==="last_month"})}," 上月 ",2),s("button",{onClick:e[17]||(e[17]=a=>x("this_year")),class:r({active:h.value==="this_year"})}," 今年 ",2),s("button",{onClick:e[18]||(e[18]=a=>x("all")),class:r({active:h.value==="all"})}," 全部 ",2)])]),s("div",Ze,"数据量 "+T(le.value),1),s("div",qe,[s("div",Ke,[s("button",{onClick:e[19]||(e[19]=a=>z("all")),class:r({active:E.value==="all"})}," 全部 ",2),s("button",{onClick:e[20]||(e[20]=a=>z("upload")),class:r({active:E.value==="upload"})}," 仅上传 ",2),s("button",{onClick:e[21]||(e[21]=a=>z("download")),class:r({active:E.value==="download"})}," 仅下载 ",2)])])]),s("div",{ref_key:"trafficChart",ref:q,class:"chart-body"},null,512)])])),[[o,P.value]])}}},je=ce(Pe,[["__scopeId","data-v-894f5fc8"]]);export{je as default};
